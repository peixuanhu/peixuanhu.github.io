---
title: 设计模式9-原型模式
categories:
	- Design Pattern
---

# 原型模式

## 定义

原型模式（Prototype），用原型实例指定创建对象的种类，并且通过复制这些原型创建新的对象。

## 原型模式结构图

![原型模式结构图.jpg](https://s2.loli.net/2023/10/05/MWng9htBKl2oAVD.jpg)

## 基本代码

原型类

```java
abstract class Prototype implements Cloneable {
    private String id;
    
    public Prototype(String id) {
        this.id = id;
    }
    
    public String getID() {
        return this.id;
    }
    
    // 原型模式关键：clone方法
    public Object clone() {
        Object object = null;
        try {
            object = super.clone();
        } catch (CloneNotSupportedException e) {
            System.err.println("Clone异常");
        }
        return object;
    }
}
```

具体原型类：

```java
class ConcretePrototype extends Prototype {
    
    public ConcretePrototype(String id) {
        super(id);
    }
}
```

客户端代码：

```java
ConcretePrototype p1 = new ConcretePrototype("123456");
System.out.println("原ID: " + p1.getID());

ConcretePrototype c1 = (ConcretePrototype)p1.clone();
System.out.println("克隆ID: " + c1.getID());
```

> 对于Java而言，那个原型抽象类Prototype是用不着的，因为克隆实在是太常用了，所以Java提供了Cloneable接口，其中就是唯一的一个方法clone()，这样就只需要实现这个接口就可以完成原型模式了。

## clone的好处

一般在初始化的信息不发生变化的情况下，克隆是最好的办法

- 隐藏对象创建的细节，且修改时可以对特定对象修改，相同的部分也无需重复
- 提高性能：不用重新初始化对象，而是动态地获得对象运行时的状态

## 浅拷贝与深拷贝

super.clone()方法是这样：

- 如果字段是值类型的，则对该字段执行逐位复制
- 如果字段是引用类型，则复制引用但不复制引用的对象

因此，原始对象及其副本引用同一对象。

## 例：简历

招聘时投递的简历，可以手抄也可以复印

### v1初步实现

每生成一份简历，就要实例化一个Resume类的对象。类似于手写，信息需要填写多次，容易出错。

#### 代码实现

简历类 `Resume`：

```java
class Resume {
    
    private String name;
    private String sex;
    private String age;
    private String timeArea;
    private String company;
    
    public Resume(String name) {
        this.name = name;
    }
    
    // 设置个人信息
    public void setPersonalInfo(String sex, String age) {
        this.sex = sex;
        this.age = age;
    }
    
    // 设置工作经历
    public void setWorkExperience(String timeArea, String company) {
        this.timeArea = timeArea;
        this.company = company;
    }
    
    // 展示简历
    public void display() {
        System.out.println(this.name + " " + this.sex + " " + this.age);
        System.out.println("工作经历 " + this.timeArea + " " + this.company);
    }
}
```

客户端代码：

```java
Resume resume1 = new Resume("Alice");
resume1.setPersonalInfo("F", "22");
resume1.setWorkExperience("2022-2023", "xx company");

Resume resume2 = new Resume("Alice");
resume2.setPersonalInfo("F", "22");
resume2.setWorkExperience("2022-2023", "xx company");

Resume resume3 = new Resume("Alice");
resume3.setPersonalInfo("F", "22");
resume3.setWorkExperience("2022-2023", "xx company");

resume1.display();
resume2.display();
resume3.display();

// 错误的代码：引用传递 - 实际上指向的是同一个对象
Resume resume1 = new Resume("Alice");
resume1.setPersonalInfo("F", "22");
resume1.setWorkExperience("2022-2023", "xx company");

Resume resume2 = resume1;
Resume resume3 = resume1;
```

### v2原型实现

#### 代码实现

简历类：

```java
class Resume implements Cloneable {
    
    private String name;
    private String sex;
    private String age;
    private String timeArea;
    private String company;
    
    public Resume(String name) {
        this.name = name;
    }
    
    ... // set方法
        
    // 重写clone()方法
    public Resume clone() {
        Resume object = null;
        try {
            object = (Resume)super.clone();
        } catch (CloneNotSupportedException e) {
            System.err.println("Clone异常");
        }
        return object;
    }
}
```

客户端代码：

```java
Resume resume1 = new Resume("Alice");
resume1.setPersonalInfo("F", "22");
resume1.setWorkExperience("2022-2023", "xx company");

Resume resume2 = resume1.clone();
resume2.setWorkExperience("2021-2022", "yy company");

Resume resume3 = resume1.clone();
resume3.setPersonalInfo("M", "23");

resume1.display();
resume2.display();
resume3.display();
```

### v3浅拷贝与深拷贝实现

将 `workExperience` 单独作为一个类，其中有时间区间和公司名称属性

#### 浅拷贝

不同resume对象指向的workExperience实际上是同一个

##### 结构图

![原型模式v3浅拷贝.jpg](https://s2.loli.net/2023/10/05/p7GNTdRsmej3yWL.jpg)

##### 代码实现

工作经历类：

```java
class WorkExperience {
    
    private String timeArea;
    private String company;
    
    public String getTimeArea() {
        return this.timeArea;
    }
    public void setTimeArea(String value) {
        this.timeArea = value;
    }
    
    public String getCompany() {
        return this.company;
    }
    public void setCompany(String value) {
        this.company = vaule;
    }
}
```

简历类：

```java
class Resume implements Cloneable {
    
    private String name;
    private String sex;
    private String age;
    private WorkExperience work; // 声明一个工作经历的对象
    
    public Resume(String name) {
        this.name = name;
        this.work = new WorkExperience(); // 对这个工作经历对象实例化
    }
    
    // 设置个人信息
    public void setPersonalInfo(String sex, String age) {
        this.sex = sex;
        this.age = age;
    }
    
    // 设置工作经历
    public void setWorkExperience(String timeArea, String company) {
        this.work.setTimeArea(timeArea); // 给工作经历实例的时间赋值
        this.work.setCompany(company); // 给工作经历实例的公司赋值
    }
    
    // 展示简历
    public void display() {
        System.out.println(this.name + " " + this.sex + " " + this.age);
        System.out.println("工作经历 " + this.work.getTimeArea() + " " + this.work.getCompany());
    }
    
    public Resume clone() {
        Resume object = null;
        try {
            object = (Resume)super.clone();
        } catch(CloneNotSupportedException e) {
            System.err.println("Clone异常");
        }
        return object;
    }
}
```

客户端代码：

```java
Resume resume1 = new Resume("Alice");
resume1.setPersonalInfo("F", "22");
resume1.setWorkExperience("2022-2023", "xx company");

Resume resume2 = resume1.clone();
resume2.setWorkExperience("2021-2022", "yy company");

Resume resume3 = resume1.clone();
resume3.setPersonalInfo("M", "23");
resume2.setWorkExperience("2020-2021", "zz company");

resume1.display();
resume2.display();
resume3.display();
```

###### 结果

实际结果与期望结果并不符合，前两次的工作经历数据被最后一次数据给覆盖了。

###### 原因

这种拷贝方式是**浅拷贝**。对于值类型，没什么问题；对引用类型，就只是复制了引用，对引用的对象还是指向了原来的对象。

#### 深拷贝

我们希望是resume1、resume2、resume3三个引用的对象是不同的，复制时就一变二，二变三，此时，我们就叫这种方式为 `深拷贝`，深拷贝把引用对象的变量指向复制过的新对象，而不是原有的被引用的对象。

深复制要深入到多少层，需要事先就考虑好，而且要当心出现循环引用的问题，需要小心处理，这里比较复杂，可以慢慢研究。

##### 结构图

![原型模式v3深拷贝.jpg](https://s2.loli.net/2023/10/05/yRPYeD53NJKVduL.jpg)

##### 代码实现

工作经历类：

```java
class WorkExperience implements Cloneable {
    
    private String timeArea;
    private String company;
    
    public String getTimeArea() {
        return this.timeArea;
    }
    public void setTimeArea(String value) {
        this.timeArea = value;
    }
    
    public String getCompany() {
        return this.company;
    }
    public void setCompany(String value) {
        this.company = vaule;
    }
    
    // 重写clone方法
    public WorkExperience clone() {
        WorkExperience object = null;
        try {
            object = (WorkExperience)super.clone();
        } catch (CloneNotSupportedException e) {
            System.err.println("Clone异常");
        }
        return object;
    }
}
```

简历类：

```java
class Resume implements Cloneable {
    
    private String name;
    private String sex;
    private String age;
    private WorkExperience work; // 声明一个工作经历的对象
    
    public Resume(String name) {
        this.name = name;
        this.work = new WorkExperience(); // 对这个工作经历对象实例化
    }
    
    // 设置个人信息
    public void setPersonalInfo(String sex, String age) {
        this.sex = sex;
        this.age = age;
    }
    
    // 设置工作经历
    public void setWorkExperience(String timeArea, String company) {
        this.work.setTimeArea(timeArea); // 给工作经历实例的时间赋值
        this.work.setCompany(company); // 给工作经历实例的公司赋值
    }
    
    // 展示简历
    public void display() {
        System.out.println(this.name + " " + this.sex + " " + this.age);
        System.out.println("工作经历 " + this.work.getTimeArea() + " " + this.work.getCompany());
    }
    
    public Resume clone() {
        Resume object = null;
        try {
            object = (Resume)super.clone();
            object.work = this.work.clone(); // 新增该条语句，对work进行深拷贝
        } catch(CloneNotSupportedException e) {
            System.err.println("Clone异常");
        }
        return object;
    }
}
```

客户端代码：

```java
Resume resume1 = new Resume("Alice");
resume1.setPersonalInfo("F", "22");
resume1.setWorkExperience("2022-2023", "xx company");

Resume resume2 = resume1.clone();
resume2.setWorkExperience("2021-2022", "yy company");

Resume resume3 = resume1.clone();
resume3.setPersonalInfo("M", "23");
resume2.setWorkExperience("2020-2021", "zz company");

resume1.display();
resume2.display();
resume3.display();
```

###### 结果

这时客户端输出结果达到预期效果。